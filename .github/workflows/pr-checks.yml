name: PR Checks

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read
  pull-requests: write

jobs:
  checks:
    runs-on: ubuntu-latest
    if: >-
      github.event.pull_request.head.repo.full_name == github.repository ||
      contains(github.event.pull_request.labels.*.name, 'safe-to-test')
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      PR_AUTHOR: ${{ github.event.pull_request.user.login }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci

      # 1. Type check
      - name: Type check
        id: typecheck
        run: npx tsc --noEmit

      - name: Comment on type check failure
        if: failure() && steps.typecheck.outcome == 'failure'
        continue-on-error: true
        run: |
          gh pr comment "$PR_NUMBER" --body \
          "@$PR_AUTHOR **Type check failed.**

          Run \`tsc --noEmit\` locally to see the errors."

      # 2. Lint
      - name: Lint
        id: lint
        run: npm run lint

      - name: Comment on lint failure
        if: failure() && steps.lint.outcome == 'failure'
        continue-on-error: true
        run: |
          gh pr comment "$PR_NUMBER" --body \
          "@$PR_AUTHOR **Linting failed.**

          Run \`npm run lint\` to see issues, or \`npm run lint:fix\` to auto-fix."

      # 3. Format check
      - name: Format check
        id: format
        run: npm run format:check

      - name: Comment on format failure
        if: failure() && steps.format.outcome == 'failure'
        continue-on-error: true
        run: |
          gh pr comment "$PR_NUMBER" --body \
          "@$PR_AUTHOR **Formatting check failed.**

          Run \`npm run format\` to auto-format, then commit the changes."

      # 4. Unused code
      - name: Unused code check
        id: knip
        run: npm run knip

      - name: Comment on unused code failure
        if: failure() && steps.knip.outcome == 'failure'
        continue-on-error: true
        run: |
          gh pr comment "$PR_NUMBER" --body \
          "@$PR_AUTHOR **Unused exports or dependencies detected.**

          Run \`npm run knip\` locally to see what needs to be removed or re-exported."

      # 5. Duplication
      - name: Duplication check
        id: duplication
        run: npm run duplication

      - name: Comment on duplication failure
        if: failure() && steps.duplication.outcome == 'failure'
        continue-on-error: true
        run: |
          gh pr comment "$PR_NUMBER" --body \
          "@$PR_AUTHOR **Code duplication detected.**

          Run \`npm run duplication\` locally to see duplicated blocks."

      # 6. Tests
      - name: Tests
        id: test
        run: npm test

      - name: Comment on test failure
        if: failure() && steps.test.outcome == 'failure'
        continue-on-error: true
        run: |
          gh pr comment "$PR_NUMBER" --body \
          "@$PR_AUTHOR **Tests failed.**

          Run \`npm test\` locally to see which tests are failing."

      # All passed — assign reviewer
      - name: Assign reviewer
        if: success() && github.event.pull_request.user.login != github.repository_owner
        continue-on-error: true
        run: |
          gh pr edit "$PR_NUMBER" --add-reviewer "${{ github.repository_owner }}"

  benchmark:
    needs: checks
    runs-on: ubuntu-latest
    if: >-
      github.event.pull_request.head.repo.full_name == github.repository ||
      contains(github.event.pull_request.labels.*.name, 'safe-to-test')
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
    steps:
      # 1. Baseline: checkout main and run benchmarks
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Baseline benchmarks (main)
        id: baseline
        continue-on-error: true
        run: npx vitest bench --outputJson /tmp/bench-baseline.json

      # 2. PR branch: checkout and run benchmarks
      - uses: actions/checkout@v4
        with:
          clean: false
      - run: npm ci
      - name: PR benchmarks
        id: bench
        run: npx vitest bench --outputJson /tmp/bench-pr.json

      # 3. Build comparison table and post as PR comment
      - name: Post benchmark results
        if: always() && steps.bench.outcome == 'success'
        run: |
          node -e '
          const fs = require("fs");

          function loadBenches(path) {
            try {
              const data = JSON.parse(fs.readFileSync(path, "utf8"));
              return data.files.flatMap(f => f.groups.flatMap(g => g.benchmarks));
            } catch { return []; }
          }

          function fmt(n) {
            return n >= 1000 ? n.toLocaleString("en-US", { maximumFractionDigits: 0 })
                             : n.toFixed(2);
          }

          function buildTable(label, prBenches, baseBenches) {
            if (prBenches.length === 0) return [];

            const baseMap = new Map();
            for (const b of baseBenches) baseMap.set(b.name, b);
            const hasBaseline = baseMap.size > 0;

            const rows = [];
            for (const b of prBenches) {
              const base = baseMap.get(b.name);
              if (hasBaseline && base) {
                const change = ((b.hz - base.hz) / base.hz) * 100;
                const sign = change >= 0 ? "+" : "";
                const icon = Math.abs(change) < 2 ? "~" : change > 0 ? ":arrow_up:" : ":arrow_down:";
                rows.push(
                  "| " + b.name +
                  " | " + fmt(base.hz) +
                  " | " + fmt(b.hz) +
                  " | " + sign + change.toFixed(1) + "%" +
                  " | " + icon + " |"
                );
              } else {
                rows.push(
                  "| " + b.name +
                  " | — | " + fmt(b.hz) +
                  " | — | |"
                );
              }
            }

            return [
              "### " + label,
              "",
              "| Benchmark | main (ops/s) | PR (ops/s) | Change | |",
              "|---|--:|--:|--:|---|",
              ...rows,
            ];
          }

          const sections = [
            ...buildTable("Computation (happy-dom)",
              loadBenches("/tmp/bench-pr.json"),
              loadBenches("/tmp/bench-baseline.json")),
          ];

          const hasAnyBaseline =
            loadBenches("/tmp/bench-baseline.json").length > 0;

          const note = hasAnyBaseline
            ? "_~ means within noise (< 2%). Measured on CI — relative changes matter, absolute numbers vary between runs._"
            : "_No baseline available on main — showing PR results only. Comparison will appear on future PRs._";

          const body = [
            "<!-- benchmark-results -->",
            "## Benchmark Results",
            "",
            ...sections,
            "",
            note,
          ].join("\n");

          fs.writeFileSync("/tmp/bench-comment.md", body);
          '

          BODY=$(cat /tmp/bench-comment.md)

          # Find existing benchmark comment
          COMMENT_ID=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.body | contains("<!-- benchmark-results -->")) | .id' \
            | head -1)

          if [ -n "$COMMENT_ID" ]; then
            gh api "repos/${{ github.repository }}/issues/comments/${COMMENT_ID}" \
              -X PATCH -f body="$BODY"
          else
            gh pr comment "$PR_NUMBER" --body "$BODY"
          fi
